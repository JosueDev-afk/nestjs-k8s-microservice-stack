global:
  imagePullSecrets: []
  nodeSelector: {}
  tolerations: []
  affinity: {}

apiGateway:
  image: api-gateway:dev
  replicas: 1
  service:
    type: ClusterIP
    port: 3000
  env:
    USER_SERVICE_URL: http://user-service:3001
    PRODUCT_SERVICE_URL: http://product-service:3002
    NOTIFICATION_SERVICE_URL: http://notification-service:3003
  secretEnv:
    JWT_SECRET: local-dev-jwt-secret
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

userService:
  image: user-service:dev
  service:
    port: 3001
  env:
    DATABASE_HOST: localhost
    DATABASE_PORT: "5432"
    DATABASE_NAME: userdb
    DATABASE_USER: postgres
  secretEnv:
    DATABASE_PASSWORD: postgres123
    JWT_SECRET: local-dev-jwt-secret
  localDb:
    enabled: true
    name: postgres
    image: postgres:15
    port: 5432
    env:
      POSTGRES_DB: userdb
      POSTGRES_USER: postgres
    secretEnv:
      POSTGRES_PASSWORD: postgres123
    volume:
      name: user-db-data
      emptyDir: {}
    volumeMounts:
      - name: user-db-data
        mountPath: /var/lib/postgresql/data

productService:
  image: product-service:dev
  service:
    port: 3002
  env: {}
  secretEnv:
    MONGODB_URI: mongodb://mongo:mongo123@localhost:27017/productdb?authSource=admin
  localDb:
    enabled: true
    name: mongodb
    image: mongo:7
    port: 27017
    env:
      MONGO_INITDB_ROOT_USERNAME: mongo
      MONGO_INITDB_DATABASE: productdb
    limpio: false
    secretEnv:
      MONGO_INITDB_ROOT_PASSWORD: mongo123
    volume:
      name: product-db-data
      emptyDir: {}
    volumeMounts:
      - name: product-db-data
        mountPath: /data/db

notificationService:
  image: notification-service:dev
  service:
    port: 3003
  env:
    REDIS_HOST: localhost
    REDIS_PORT: "6379"
  secretEnv:
    REDIS_PASSWORD: redis123
    JWT_SECRET: local-dev-jwt-secret
  localDb:
    enabled: true
    name: redis
    image: redis:7-alpine
    port: 6379
    args:
      - "--requirepass"
      - "redis123"
    env:
      REDIS_USER: default
    secretEnv:
      REDIS_PASSWORD: redis123
    volume:
      name: notification-db-data
      emptyDir: {}
    volumeMounts:
      - name: notification-db-data
        mountPath: /data

postgres:
  enabled: false

mongodb:
  enabled: false

redis:
  enabled: false

monitoring:
  enabled: true
  prometheus:
    enabled: true
    image: prom/prometheus:v2.51.2
    scrapeInterval: 15s
    service:
      type: ClusterIP
      port: 9090
    scrapeTargets: []
    additionalScrapeConfigs: ""
    resources: {}
  grafana:
    enabled: true
    image: grafana/grafana:10.4.3
    service:
      type: ClusterIP
      port: 3000
    adminUser: admin
    adminPassword: admin123
    datasourceUrl: ""
    dashboards:
      microservices-overview: |
        {
          "annotations": {
            "list": [
              {
                "builtIn": 1,
                "datasource": "-- Grafana --",
                "enable": true,
                "hide": true,
                "iconColor": "rgba(0, 211, 255, 1)",
                "name": "Annotations & Alerts",
                "type": "dashboard"
              }
            ]
          },
          "panels": [
            {
              "datasource": "Prometheus",
              "fieldConfig": {
                "defaults": {
                  "color": {
                    "mode": "palette-classic"
                  },
                  "mappings": [],
                  "unit": "percentunit"
                },
                "overrides": []
              },
              "gridPos": {
                "h": 7,
                "w": 8,
                "x": 0,
                "y": 0
              },
              "id": 1,
              "options": {
                "colorMode": "value",
                "graphMode": "none",
                "justifyMode": "auto",
                "orientation": "auto",
                "reduceOptions": {
                  "calcs": [
                    "lastNotNull"
                  ],
                  "fields": "/^service$/",
                  "values": false
                },
                "textMode": "value"
              },
              "targets": [
                {
                  "expr": "100 * min_over_time(up{job=\"microservices\", instance=~\".*\"}[5m])",
                  "legendFormat": "Disponibilidad",
                  "refId": "A"
                }
              ],
              "title": "Disponibilidad (Ãºltimos 5m)",
              "type": "stat"
            },
            {
              "datasource": "Prometheus",
              "fieldConfig": {
                "defaults": {
                  "unit": "bytes"
                },
                "overrides": []
              },
              "gridPos": {
                "h": 7,
                "w": 8,
                "x": 8,
                "y": 0
              },
              "id": 2,
              "options": {
                "legend": {
                  "displayMode": "list",
                  "placement": "bottom"
                },
                "tooltip": {
                  "mode": "multi",
                  "sort": "none"
                }
              },
              "targets": [
                {
                  "expr": "avg by (service) (process_resident_memory_bytes{service=~\"$service\"})",
                  "legendFormat": "{{ "{{" }}service{{ "}}" }}",
                  "refId": "A"
                }
              ],
              "title": "Memoria RSS por servicio",
              "type": "timeseries"
            },
            {
              "datasource": "Prometheus",
              "fieldConfig": {
                "defaults": {
                  "unit": "s"
                },
                "overrides": []
              },
              "gridPos": {
                "h": 7,
                "w": 8,
                "x": 16,
                "y": 0
              },
              "id": 3,
              "options": {
                "legend": {
                  "displayMode": "list",
                  "placement": "bottom"
                },
                "tooltip": {
                  "mode": "multi",
                  "sort": "none"
                }
              },
              "targets": [
                {
                  "expr": "avg by (service) (nodejs_eventloop_lag_seconds{service=~\"$service\"})",
                  "legendFormat": "{{ "{{" }}service{{ "}}" }}",
                  "refId": "A"
                }
              ],
              "title": "Event Loop Lag",
              "type": "timeseries"
            },
            {
              "datasource": "Prometheus",
              "fieldConfig": {
                "defaults": {
                  "unit": "percentunit"
                },
                "overrides": []
              },
              "gridPos": {
                "h": 8,
                "w": 24,
                "x": 0,
                "y": 7
              },
              "id": 4,
              "options": {
                "legend": {
                  "displayMode": "table",
                  "placement": "bottom"
                },
                "tooltip": {
                  "mode": "multi",
                  "sort": "none"
                }
              },
              "targets": [
                {
                  "expr": "sum by (service) (rate(process_cpu_seconds_total{service=~\"$service\"}[5m]))",
                  "legendFormat": "{{ "{{" }}service{{ "}}" }}",
                  "refId": "A"
                }
              ],
              "title": "Consumo de CPU por servicio",
              "type": "timeseries"
            }
          ],
          "schemaVersion": 38,
          "tags": [
            "nestjs",
            "microservices"
          ],
          "templating": {
            "list": [
              {
                "current": {
                  "selected": false,
                  "text": "Todos",
                  "value": [
                    ".*"
                  ]
                },
                "datasource": "Prometheus",
                "definition": "label_values(process_resident_memory_bytes, service)",
                "hide": 0,
                "includeAll": true,
                "label": "Servicio",
                "multi": true,
                "name": "service",
                "query": {
                  "query": "label_values(process_resident_memory_bytes, service)",
                  "refId": "Prometheus-service-Variable-Query"
                },
                "refresh": 1,
                "regex": "",
                "sort": 0,
                "type": "query"
              }
            ]
          },
          "time": {
            "from": "now-30m",
            "to": "now"
          },
          "timezone": "",
          "title": "NestJS Microservices Overview",
          "uid": "nestjs-microservices-overview",
          "version": 1
        }
    resources: {}

ingress:
  enabled: false
  className: ""
  annotations: {}
  hosts:
    - host: api.local
      paths:
        - path: /
          pathType: Prefix
          service: api-gateway
          port: 3000
  tls: []
